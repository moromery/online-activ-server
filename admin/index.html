<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لوحة تحكم السيريالات</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--accent:#4f46e5;--accent-dark:#3730a3}
  html,body{height:100%}
  body{
    font-family:'Cairo',sans-serif;
    margin:0;background:linear-gradient(135deg,#eef2ff 0,#eff6ff 100%);
    display:flex;align-items:center;justify-content:center;padding:20px;
  }
  .card{width:100%;max-width:1000px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(15,23,42,.08);overflow:hidden}
  header{display:flex;justify-content:space-between;align-items:center;padding:18px 22px;border-bottom:1px solid #f1f5f9}
  header h1{margin:0;font-size:20px;color:#0f172a}
  .main{padding:18px}
  .cols{display:grid;grid-template-columns:1fr 320px;gap:16px}
  .panel{background:#fafafa;padding:12px;border-radius:8px;border:1px solid #f1f5f9}
  label{display:block;font-size:13px;color:#334155;margin-bottom:6px}
  input[type=text],input[type=number],input[type=password],select{
    width:100%;padding:8px 10px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;box-sizing:border-box;
  }
  button{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  button.ghost{background:#f8fafc;color:#0f172a;border:1px solid #e6eefc}
  .muted{color:#64748b;font-size:13px}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
  th,td{padding:8px;border:1px solid #f1f5f9;text-align:left}
  th{background:#f8fafc}
  td.actions{white-space:nowrap}
  .small{padding:6px 8px;font-size:12px;border-radius:6px}
  .danger{background:#ef4444}
  .yellow{background:#f59e0b}
  .success{background:#10b981}
  .notice{position:fixed;right:20px;bottom:20px;padding:10px 14px;border-radius:10px;color:#fff;box-shadow:0 8px 22px rgba(2,6,23,.12)}
  .hidden{display:none}
  .center{text-align:center}
  @media(max-width:900px){ .cols{grid-template-columns:1fr; } header{flex-direction:column;gap:8px} }
</style>
</head>
<body>
  <div class="card" id="app">
    <header>
      <h1>لوحة تحكم السيريالات</h1>
      <div id="authArea">
        <!-- login / logout area -->
      </div>
    </header>

    <div class="main">
      <div id="loggedOut" class="center" style="display:none">
        <p class="muted">الصفحة تحتاج تسجيل دخول الأدمن. كلمة المرور محفوظة فقط في المتصفح (localStorage) مؤقتًا لتسهيل الاستخدام.</p>
      </div>

      <div class="cols">
        <div>
          <div class="panel" id="controlsPanel">
            <div id="loginPanel">
              <label>كلمة مرور الأدمن</label>
              <input type="password" id="adminPassword" placeholder="أدخل كلمة المرور">
              <div style="margin-top:8px;display:flex;gap:8px">
                <button id="loginBtn">دخول</button>
                <button id="clearTokenBtn" class="ghost">مسح التوكن</button>
              </div>
              <p class="muted" style="margin-top:8px">مصدر API: <span id="apiSource" style="font-weight:700"></span></p>
            </div>

            <div id="actionsPanel" style="display:none">
              <label>اسم العميل</label>
              <input type="text" id="clientName" placeholder="مثال: محمد">
              <div style="display:flex;gap:8px;margin-top:10px">
                <input type="number" id="quantity" value="1" min="1" style="width:110px">
                <button id="generateBtn">توليد</button>
                <button id="refreshBtn" class="ghost">تحديث</button>
                <button id="downloadBtn" class="ghost">تنزيل CSV</button>
              </div>
              <p class="muted" style="margin-top:8px">يمكنك توليد دفعات عن طريق تغيير الكمية.</p>
            </div>
          </div>

          <div class="panel" style="margin-top:12px">
            <label>بحث (سيريال / عميل / HWID)</label>
            <input type="text" id="searchInput" placeholder="ابحث هنا">
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <label class="muted">حجم الصفحة</label>
              <select id="pageSize" style="width:90px">
                <option value="10">10</option><option value="25" selected>25</option><option value="50">50</option>
              </select>
              <div style="flex:1"></div>
              <div class="muted">عرض <span id="rangeInfo">0-0</span></div>
            </div>
          </div>
        </div>

        <div>
          <div class="panel" style="min-height:120px;display:flex;flex-direction:column">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>قائمة السيريالات</strong>
              <div class="muted">إجمالي: <span id="totalCount">0</span></div>
            </div>

            <div id="tableWrap" style="overflow:auto;margin-top:8px">
              <table id="serialTable">
                <thead>
                  <tr>
                    <th>Serial</th><th>عميل</th><th>HWID</th><th>فعال</th><th>تاريخ الإنشاء</th><th>تاريخ التفعيل</th><th>خيارات</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
              <div>
                <button id="firstPage" class="small">الأول</button>
                <button id="prevPage" class="small">السابق</button>
                <button id="nextPage" class="small">التالي</button>
                <button id="lastPage" class="small">الأخير</button>
              </div>
              <div class="muted">الصفحة <span id="pageNum">1</span> / <span id="pageTotal">1</span></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="notice" class="notice hidden"></div>

<script>
/*
  Simple Admin HTML/JS for Moro POS
  - Auto-detect API_URL (localhost vs Railway)
  - Uses /admin/login to get token (saved in localStorage key: moro_admin_token)
  - Sends Authorization: Bearer <token> when available
  - Works even if server doesn't require token
*/

(() => {
  const API_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
    ? 'http://localhost:3000'
    : 'https://online-activ-server-production.up.railway.app';

  // elements
  const apiSource = document.getElementById('apiSource');
  const loginBtn = document.getElementById('loginBtn');
  const adminPassword = document.getElementById('adminPassword');
  const clearTokenBtn = document.getElementById('clearTokenBtn');
  const actionsPanel = document.getElementById('actionsPanel');
  const loginPanel = document.getElementById('loginPanel');
  const generateBtn = document.getElementById('generateBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const clientNameInput = document.getElementById('clientName');
  const quantityInput = document.getElementById('quantity');
  const serialTableBody = document.querySelector('#serialTable tbody');
  const noticeEl = document.getElementById('notice');
  const searchInput = document.getElementById('searchInput');
  const pageSizeSelect = document.getElementById('pageSize');
  const totalCount = document.getElementById('totalCount');
  const rangeInfo = document.getElementById('rangeInfo');
  const pageNum = document.getElementById('pageNum');
  const pageTotal = document.getElementById('pageTotal');
  const firstPageBtn = document.getElementById('firstPage');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  const lastPageBtn = document.getElementById('lastPage');

  apiSource.textContent = API_URL;

  // state
  let token = localStorage.getItem('moro_admin_token') || '';
  let licenses = []; // array of items { serialKey, customerName, hwid, active, createdAt, activatedAt }
  let filtered = [];
  let page = 1;
  let pageSize = parseInt(pageSizeSelect.value, 10) || 25;

  const headers = () => {
    const h = { 'Content-Type': 'application/json' };
    if (token) h['Authorization'] = 'Bearer ' + token;
    return h;
  };

  // helpers
  function showNotice(text, type='info'){
    noticeEl.textContent = text;
    noticeEl.style.background = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#334155';
    noticeEl.classList.remove('hidden');
    setTimeout(()=> noticeEl.classList.add('hidden'), 3500);
  }
  function safeCSVCell(s){
    if (s == null) return '""';
    return '"' + String(s).replace(/"/g,'""') + '"';
  }

  function updateAuthUI(){
    if (token){
      loginPanel.style.display = 'none';
      actionsPanel.style.display = 'block';
      document.getElementById('loggedOut').style.display = 'none';
      document.getElementById('authArea').innerHTML = `
        <div style="display:flex;gap:8px;align-items:center">
          <span class="muted">المصادقة: محفوظة</span>
          <button id="logoutBtn" class="ghost" style="padding:6px 8px">تسجيل خروج</button>
        </div>`;
      document.getElementById('logoutBtn').onclick = () => {
        token = '';
        localStorage.removeItem('moro_admin_token');
        updateAuthUI();
        showNotice('تم تسجيل الخروج','info');
      };
    } else {
      loginPanel.style.display = '';
      actionsPanel.style.display = 'none';
      document.getElementById('authArea').innerHTML = '';
      document.getElementById('loggedOut').style.display = '';
    }
  }

  async function api(path, opts = {}){
    const url = API_URL + path;
    try {
      const res = await fetch(url, Object.assign({ headers: headers() }, opts));
      const data = await res.json().catch(()=>({}));
      return { ok: res.ok, status: res.status, data };
    } catch (err) {
      return { ok:false, err };
    }
  }

  // login
  loginBtn.addEventListener('click', async ()=>{
    const pwd = adminPassword.value.trim();
    if (!pwd) return showNotice('ادخل كلمة المرور','error');
    showNotice('جاري تسجيل الدخول...');
    const r = await api('/admin/login', {
      method: 'POST',
      body: JSON.stringify({ password: pwd })
    });
    if (!r.ok){
      showNotice('فشل الاتصال بالسيرفر','error');
      return;
    }
    if (r.data && r.data.success && r.data.token){
      token = r.data.token;
      localStorage.setItem('moro_admin_token', token);
      adminPassword.value = '';
      updateAuthUI();
      showNotice('تم تسجيل الدخول','success');
      fetchLicenses();
    } else {
      // server might not expose /admin/login (old server) or returned error
      // if server doesn't have login, we still continue without token
      if (r.status === 404 || (r.data && r.data.message && r.data.message.toLowerCase().includes('not found'))){
        showNotice('نظام المصادقة غير متوفر على السيرفر — الاستمرار بدون توكن','info');
        token = ''; // ensure no token
        updateAuthUI();
        fetchLicenses();
      } else {
        showNotice(r.data && r.data.message ? r.data.message : 'فشل تسجيل الدخول','error');
      }
    }
  });

  clearTokenBtn.addEventListener('click', ()=>{
    token = '';
    localStorage.removeItem('moro_admin_token');
    updateAuthUI();
    showNotice('تم مسح التوكن','info');
  });

  // CRUD + helpers
  async function fetchLicenses(){
    const r = await api('/licenses', { method: 'GET' });
    if (!r.ok) {
      showNotice('فشل جلب السيريالات','error'); return;
    }
    const obj = r.data || {};
    licenses = Object.keys(obj).map(k => Object.assign({ serialKey: k }, obj[k]));
    // sort by createdAt desc
    licenses.sort((a,b)=> new Date(b.createdAt||0) - new Date(a.createdAt||0));
    applyFilterAndRender();
  }

  async function generateSerials(){
    const name = clientNameInput.value.trim();
    const qty = parseInt(quantityInput.value,10);
    if (!name) return showNotice('ادخل اسم العميل','error');
    if (!qty || qty < 1) return showNotice('الكمية غير صحيحة','error');
    showNotice('جاري التوليد...');
    const r = await api('/generate-serial', {
      method: 'POST',
      body: JSON.stringify({ customerName: name, quantity: qty })
    });
    if (!r.ok) return showNotice('فشل الاتصال','error');
    if (r.data && r.data.success){
      showNotice('تم إنشاء السيريالات','success');
      clientNameInput.value = '';
      quantityInput.value = 1;
      fetchLicenses();
    } else {
      showNotice(r.data && r.data.message ? r.data.message : 'فشل التوليد','error');
    }
  }

  async function deleteSerial(key){
    if (!confirm('هل تريد حذف هذا السيريال؟')) return;
    const r = await api('/licenses/' + encodeURIComponent(key), { method: 'DELETE' });
    if (!r.ok) return showNotice('فشل الاتصال','error');
    if (r.data && r.data.success){
      showNotice('تم الحذف','success');
      fetchLicenses();
    } else showNotice(r.data && r.data.message ? r.data.message : 'فشل الحذف','error');
  }

  async function editSerial(key){
    const current = licenses.find(x => x.serialKey === key);
    const newName = prompt('ادخل اسم العميل الجديد:', current ? (current.customerName||'') : '');
    if (newName === null) return;
    const r = await api('/licenses/' + encodeURIComponent(key), {
      method: 'PUT',
      body: JSON.stringify({ customerName: String(newName) })
    });
    if (!r.ok) return showNotice('فشل الاتصال','error');
    if (r.data && r.data.success){
      showNotice('تم التعديل','success');
      fetchLicenses();
    } else showNotice(r.data && r.data.message ? r.data.message : 'فشل التعديل','error');
  }

  function downloadCSV(){
    if (!licenses.length) return showNotice('لا يوجد سيريالات','info');
    const rows = [['Serial Key','Client Name','HWID','Active','Created At','Activated At']];
    licenses.forEach(l => rows.push([l.serialKey, l.customerName||'', l.hwid||'', l.active ? 'true' : 'false', l.createdAt||'', l.activatedAt||'']));
    const csv = rows.map(r => r.map(c => safeCSVCell(c)).join(',')).join('\\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'serials.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // filtering & pagination
  function applyFilterAndRender(){
    const q = (searchInput.value || '').toLowerCase().trim();
    filtered = licenses.filter(l => {
      if (!q) return true;
      return (l.serialKey||'').toLowerCase().includes(q) || (l.customerName||'').toLowerCase().includes(q) || (l.hwid||'').toLowerCase().includes(q);
    });
    pageSize = parseInt(pageSizeSelect.value,10) || 25;
    const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
    if (page > totalPages) page = totalPages;
    renderTable();
  }

  function renderTable(){
    const total = filtered.length;
    totalCount.textContent = total;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    pageNum.textContent = page;
    pageTotal.textContent = totalPages;
    const start = (page - 1) * pageSize;
    const end = Math.min(start + pageSize, total);
    rangeInfo.textContent = (total === 0) ? '0-0' : `${start+1}-${end}`;
    serialTableBody.innerHTML = '';
    const slice = filtered.slice(start, end);
    for (const it of slice){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="font-family:monospace">${escapeHtml(it.serialKey)}</td>
        <td>${escapeHtml(it.customerName||'-')}</td>
        <td>${escapeHtml(it.hwid||'-')}</td>
        <td>${it.active ? 'نعم' : 'لا'}</td>
        <td>${it.createdAt ? new Date(it.createdAt).toLocaleString() : '-'}</td>
        <td>${it.activatedAt ? new Date(it.activatedAt).toLocaleString() : '-'}</td>
        <td class="actions">
          <button class="small yellow" data-edit="${encodeURIComponent(it.serialKey)}">تعديل</button>
          <button class="small danger" data-del="${encodeURIComponent(it.serialKey)}">حذف</button>
        </td>
      `;
      serialTableBody.appendChild(tr);
    }
    // attach handlers
    serialTableBody.querySelectorAll('[data-del]').forEach(btn=>{
      btn.onclick = ()=> deleteSerial(decodeURIComponent(btn.getAttribute('data-del')));
    });
    serialTableBody.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.onclick = ()=> editSerial(decodeURIComponent(btn.getAttribute('data-edit')));
    });
  }

  // utils
  function escapeHtml(str){
    if (str == null) return '';
    return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
  }

  // events
  generateBtn.addEventListener('click', generateSerials);
  refreshBtn.addEventListener('click', fetchLicenses);
  downloadBtn.addEventListener('click', downloadCSV);
  searchInput.addEventListener('input', ()=>{ page = 1; applyFilterAndRender(); });
  pageSizeSelect.addEventListener('change', ()=>{ page = 1; applyFilterAndRender(); });
  firstPageBtn.addEventListener('click', ()=>{ page = 1; renderTable(); });
  prevPageBtn.addEventListener('click', ()=>{ if (page>1) page--; renderTable(); });
  nextPageBtn.addEventListener('click', ()=>{ const t = Math.ceil(filtered.length / pageSize); if (page < t) page++; renderTable(); });
  lastPageBtn.addEventListener('click', ()=>{ page = Math.ceil(filtered.length / pageSize) || 1; renderTable(); });

  // init
  updateAuthUI();
  // try to fetch at start (works whether or not token required)
  fetchLicenses();

})();
</script>
</body>
</html>
