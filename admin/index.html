<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>لوحة التحكم - توليد السيريالات</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
    font-family: 'Cairo', sans-serif;
    background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
    color: #333;
    padding: 0;
    margin: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}
.container {
    background: #fff;
    padding: 30px 40px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 900px;
}
h2 { text-align: center; color: #222; margin-bottom: 20px; }
input, button { width: 100%; padding: 10px; margin: 8px 0; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
input:focus { border-color: #6B73FF; outline: none; box-shadow: 0 0 5px rgba(107, 115, 255, 0.5); }
button { background: #6B73FF; color: #fff; border: none; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
button:hover { background: #000DFF; transform: scale(1.05); }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
table th, table td { padding: 10px; border: 1px solid #ccc; text-align: center; }
button.small-btn { padding: 5px 10px; font-size: 14px; margin: 2px; }
</style>
</head>
<body>

<div class="container" id="loginDiv">
    <h2>تسجيل دخول الأدمن</h2>
    <input type="password" id="adminPassword" placeholder="كلمة المرور">
    <button id="loginBtn">دخول</button>
</div>

<div class="container" id="dashboardDiv" style="display:none;">
    <h2>لوحة تحكم السيريالات</h2>
    <input type="text" id="clientName" placeholder="اسم العميل">
    <input type="number" id="quantity" placeholder="عدد السيريالات" min="1" value="1">
    <button id="generateBtn">توليد السيريالات</button>
    <button id="downloadCSVBtn">تنزيل CSV</button>

    <table id="serialTable">
        <thead>
            <tr>
                <th>Serial Key</th>
                <th>اسم العميل</th>
                <th>Token</th>
                <th>خيارات</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
const ADMIN_PASSWORD = "Killbil1@";
const API_URL = "https://online-activ-server-production.up.railway.app"; // رابط السيرفر على Railway

let serialList = [];

// ================= Login =================
document.getElementById('loginBtn').addEventListener('click', () => {
    const pass = document.getElementById('adminPassword').value;
    if(pass === ADMIN_PASSWORD){
        document.getElementById('loginDiv').style.display='none';
        document.getElementById('dashboardDiv').style.display='block';
        fetchLicenses();
    } else alert("كلمة المرور خاطئة!");
});

// ================= Fetch licenses =================
async function fetchLicenses(){
    try{
        const res = await fetch(`${API_URL}/licenses`);
        const data = await res.json();
        serialList = Object.keys(data).map(key => {
            const l = data[key];
            return { serialKey: key, clientName: l.customerName || "", token: l.token || "" };
        });
        refreshTable();
    } catch(err){ alert("فشل تحميل السيريالات: "+err.message); }
}

// ================= Generate Serials =================
document.getElementById('generateBtn').addEventListener('click', async ()=> {
    const clientName = document.getElementById('clientName').value.trim();
    const quantity = parseInt(document.getElementById('quantity').value);

    if(!clientName) return alert("من فضلك أدخل اسم العميل");
    if(!quantity || quantity < 1) return alert("عدد غير صحيح");

    for(let i=0; i<quantity; i++){
        try{
            const res = await fetch(`${API_URL}/generate-serial`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ customerName: clientName })
            });
            const data = await res.json();
            if(data.success){
                serialList.push({ serialKey: data.serialKey, clientName, token: data.token });
            } else alert("خطأ: "+data.message);
        } catch(err){
            alert("حدث خطأ: "+err.message);
        }
    }
    refreshTable();
});

// ================= Refresh table =================
function refreshTable(){
    const tbody = document.querySelector("#serialTable tbody");
    tbody.innerHTML="";
    serialList.forEach(item=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.serialKey}</td>
            <td>${item.clientName}</td>
            <td>${item.token}</td>
            <td>
                <button class="small-btn" onclick="editSerial('${item.serialKey}')">تعديل</button>
                <button class="small-btn" onclick="deleteSerial('${item.serialKey}')">حذف</button>
            </td>`;
        tbody.appendChild(tr);
    });
}

// ================= Edit / Delete =================
async function editSerial(serialKey){
    const newName = prompt("ادخل اسم العميل الجديد:");
    if(!newName) return;
    try{
        const res = await fetch(`${API_URL}/licenses/${serialKey}`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ customerName:newName })
        });
        const data = await res.json();
        if(data.success) fetchLicenses();
        else alert(data.message);
    } catch(err){ alert(err.message); }
}

async function deleteSerial(serialKey){
    if(!confirm("هل تريد حذف هذا السيريال؟")) return;
    try{
        const res = await fetch(`${API_URL}/licenses/${serialKey}`, { method:'DELETE' });
        const data = await res.json();
        if(data.success) fetchLicenses();
        else alert(data.message);
    } catch(err){ alert(err.message); }
}

// ================= Download CSV =================
document.getElementById('downloadCSVBtn').addEventListener('click', ()=>{
    if(serialList.length===0) return alert("لا يوجد سيريالات لتحميلها");
    let csv = "data:text/csv;charset=utf-8,Serial Key,Client Name,Token\n";
    serialList.forEach(item=>{ csv+=`${item.serialKey},${item.clientName},${item.token}\n`; });
    const encodedUri = encodeURI(csv);
    const link = document.createElement("a");
    link.setAttribute("href",encodedUri);
    link.setAttribute("download","generated_serials.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>
</body>
</html>
